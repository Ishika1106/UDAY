<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-lang="title">Uday Teacher Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body { background: linear-gradient(135deg,#0a0a0a,#1e003e,#001a33); color:#fff; font-family:sans-serif; }
.toast { position: fixed; bottom: 20px; right: 20px; background: #1e003e; border: 1px solid #7f00ff; padding: 12px 20px; border-radius: 8px; box-shadow:0 0 10px #7f00ff; opacity:0; transform:translateY(20px); transition: all 0.3s ease-in-out; }
.toast.show { opacity:1; transform:translateY(0); }
</style>
</head>
<body class="min-h-screen">

<header class="p-6 bg-gradient-to-r from-purple-900 to-blue-900 shadow-lg flex flex-col md:flex-row items-center justify-between gap-2 md:gap-0">
  <h1 class="text-3xl font-extrabold text-purple-400 flex items-center gap-2">
    <i class="fas fa-chalkboard-teacher"></i>
    <span data-lang="header">Uday Teacher Dashboard</span>
  </h1>
  <select id="languageSelect" class="p-2 rounded bg-gray-700 text-white ml-4">
    <option value="en">English</option>
    <option value="hi">हिन्दी</option>
    <option value="kn">ಕನ್ನಡ</option>
    <option value="mr">मराठी</option>
  </select>
</header>

<main class="p-8 max-w-3xl mx-auto">
  <section class="bg-gray-800 rounded-xl p-6 shadow-lg mb-8">
    <h2 class="text-2xl font-bold mb-4 text-blue-300">
      <i class="fas fa-user-graduate"></i> <span data-lang="studentRisk">Student Dropout Risk Predictor</span>
    </h2>
    
    <!-- School ID -->
    <div class="mb-4">
      <label class="block mb-1 font-medium" data-lang="schoolIdLabel">Enter School ID (case-sensitive, must match admin):</label>
      <input type="text" id="schoolIdInput" class="w-full p-2 rounded bg-gray-700 text-white mb-2" placeholder="e.g. SCHOOL_A" required>
    </div>
    
    <!-- Input Method Picker -->
    <div class="mb-4">
      <label class="block mb-1 font-medium" data-lang="inputMethodLabel">Select Input Method:</label>
      <select id="inputMethod" class="w-full p-2 rounded bg-gray-700 text-white">
        <option value="manual" data-lang="inputManual">Manually Enter Student Data</option>
        <option value="single" data-lang="inputSingle">Upload Single Excel File</option>
        <option value="multiple" data-lang="inputMultiple">Upload Multiple Excel Files (one column each)</option>
      </select>
    </div>
    
    <!-- Manual Form -->
    <form id="manualForm" class="space-y-2 mb-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="studentName" class="p-2 rounded bg-gray-700 text-white" data-lang-placeholder="studentNamePh" required>
        <input type="text" id="studentClass" class="p-2 rounded bg-gray-700 text-white" data-lang-placeholder="studentClassPh" required>
        <input type="number" id="attendance" class="p-2 rounded bg-gray-700 text-white" data-lang-placeholder="attendancePh" required>
        <input type="number" id="fees" class="p-2 rounded bg-gray-700 text-white" data-lang-placeholder="feesPh" required>
        <input type="number" id="marks" class="p-2 rounded bg-gray-700 text-white" data-lang-placeholder="marksPh" required>
      </div>
      <button type="submit" class="mt-2 w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-white">
        <i class="fas fa-chart-pie"></i> <span data-lang="predictBtn">Predict Risk</span>
      </button>
    </form>
    
    <!-- Single Excel -->
    <div id="singleExcelDiv" class="mb-4 hidden">
      <label class="block mb-1" data-lang="singleExcelLabel">Upload Excel File (Name, Class, Attendance, Fees, Marks):</label>
      <input type="file" id="singleExcelFile" accept=".xlsx,.xls" class="mb-2 text-white">
      <button onclick="predictSingleExcel()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-white">
        <i class="fas fa-chart-pie"></i> <span data-lang="predictAllBtn">Predict Risk for All</span>
      </button>
    </div>
    
    <!-- Multiple Excel -->
    <div id="multipleExcelDiv" class="mb-4 hidden">
      <label class="block mb-1" data-lang="multipleExcelLabel">Upload Multiple Excel Files (each file = one column):</label>
      <input type="file" id="multipleExcelFiles" accept=".xlsx,.xls" multiple class="mb-2 text-white">
      <button onclick="predictMultipleExcel()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-white">
        <i class="fas fa-chart-pie"></i> <span data-lang="predictAllBtn">Predict Risk for All</span>
      </button>
    </div>
    
    <!-- Output Table -->
    <table id="resultTable" class="w-full text-sm mt-4 hidden border border-gray-600"></table>
  </section>
</main>

<div id="toastContainer"></div>

<script>
const PREDICTION_ENDPOINT = "https://uday-bmub.onrender.com/predict";

// --- Translations ---
const translations = {
  en: {
    title: "Uday Teacher Dashboard",
    header: "Uday Teacher Dashboard",
    studentRisk: "Student Dropout Risk Predictor",
    schoolIdLabel: "Enter School ID (case-sensitive, must match admin):",
    inputMethodLabel: "Select Input Method:",
    inputManual: "Manually Enter Student Data",
    inputSingle: "Upload Single Excel File",
    inputMultiple: "Upload Multiple Excel Files (one column each)",
    studentNamePh: "Student Name",
    studentClassPh: "Class",
    attendancePh: "Attendance (%)",
    feesPh: "Fees Paid",
    marksPh: "Marks (%)",
    predictBtn: "Predict Risk",
    singleExcelLabel: "Upload Excel File (Name, Class, Attendance, Fees, Marks):",
    multipleExcelLabel: "Upload Multiple Excel Files (each file = one column):",
    predictAllBtn: "Predict Risk for All",
    selectSchoolId: "Please enter School ID!",
    selectFile: "Please select a file!",
    selectFiles: "Please select files!",
    predicting: "Predicting...",
    predictionDone: "Prediction complete!",
    apiError: "API request failed",
    error: "Error",
    atRisk: "At Risk",
    notAtRisk: "Not at Risk",
    student: "Student",
    class: "Class",
    attendance: "Attendance",
    fees: "Fees",
    marks: "Marks",
    dropoutRisk: "Dropout Risk",
    probability: "Probability (%)"
  },
  hi: {
    title: "उदय शिक्षक डैशबोर्ड",
    header: "उदय शिक्षक डैशबोर्ड",
    studentRisk: "छात्र ड्रॉपआउट जोखिम पूर्वानुमानक",
    schoolIdLabel: "स्कूल आईडी दर्ज करें (जैसा एडमिन में है):",
    inputMethodLabel: "इनपुट विधि चुनें:",
    inputManual: "मैन्युअल रूप से छात्र डेटा दर्ज करें",
    inputSingle: "एकल एक्सेल फ़ाइल अपलोड करें",
    inputMultiple: "एकाधिक एक्सेल फ़ाइलें अपलोड करें (हर फाइल एक कॉलम)",
    studentNamePh: "छात्र का नाम",
    studentClassPh: "कक्षा",
    attendancePh: "उपस्थिति (%)",
    feesPh: "फीस भरी",
    marksPh: "अंक (%)",
    predictBtn: "जोखिम अनुमानित करें",
    singleExcelLabel: "एक्सेल फ़ाइल अपलोड करें (नाम, कक्षा, उपस्थिति, फीस, अंक):",
    multipleExcelLabel: "एकाधिक एक्सेल फ़ाइलें अपलोड करें (हर फाइल एक कॉलम):",
    predictAllBtn: "सभी के लिए जोखिम अनुमानित करें",
    selectSchoolId: "कृपया स्कूल आईडी दर्ज करें!",
    selectFile: "कृपया फाइल चुनें!",
    selectFiles: "कृपया फाइलें चुनें!",
    predicting: "अनुमान लगाया जा रहा है...",
    predictionDone: "अनुमान पूर्ण!",
    apiError: "API अनुरोध विफल",
    error: "त्रुटि",
    atRisk: "जोखिम में",
    notAtRisk: "जोखिम में नहीं",
    student: "छात्र",
    class: "कक्षा",
    attendance: "उपस्थिति",
    fees: "फीस",
    marks: "अंक",
    dropoutRisk: "ड्रॉपआउट जोखिम",
    probability: "संभावना (%)"
  },
  kn: {
    title: "ಉದಯ ಶಿಕ್ಷಕ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್",
    header: "ಉದಯ ಶಿಕ್ಷಕ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್",
    studentRisk: "ವಿದ್ಯಾರ್ಥಿ ಡ್ರಾಪ್‌ಔಟ್ ಅಪಾಯ ಭವಿಷ್ಯವಾಣಿ",
    schoolIdLabel: "ಶಾಲೆ ಐಡಿ ನಮೂದಿಸಿ (ಆಡ್ಮಿನ್‌ನಂತೆಯೇ):",
    inputMethodLabel: "ಇನ್ಪುಟ್ ವಿಧಾನ ಆಯ್ಕೆಮಾಡಿ:",
    inputManual: "ವಿದ್ಯಾರ್ಥಿ ಡೇಟಾವನ್ನು ಕೈಯಾರೆ ನಮೂದಿಸಿ",
    inputSingle: "ಒಂದು ಎಕ್ಸೆಲ್ ಫೈಲ್ ಅಪ್ಲೋಡ್ ಮಾಡಿ",
    inputMultiple: "ಬಹು ಎಕ್ಸೆಲ್ ಫೈಲ್‌ಗಳನ್ನು ಅಪ್ಲೋಡ್ ಮಾಡಿ (ಪ್ರತಿ ಫೈಲ್ ಒಂದು ಕಾಲಮ್)",
    studentNamePh: "ವಿದ್ಯಾರ್ಥಿ ಹೆಸರು",
    studentClassPh: "ವರ್ಗ",
    attendancePh: "ಹಾಜರಿ (%)",
    feesPh: "ಶುಲ್ಕ ಪಾವತಿಸಲಾಗಿದೆ",
    marksPh: "ಅಂಕಗಳು (%)",
    predictBtn: "ಅಪಾಯ ಭವಿಷ್ಯವಾಣಿ ಮಾಡಿ",
    singleExcelLabel: "ಎಕ್ಸೆಲ್ ಫೈಲ್ ಅಪ್ಲೋಡ್ ಮಾಡಿ (ಹೆಸರು, ವರ್ಗ, ಹಾಜರಿ, ಶುಲ್ಕ, ಅಂಕಗಳು):",
    multipleExcelLabel: "ಬಹು ಎಕ್ಸೆಲ್ ಫೈಲ್‌ಗಳನ್ನು ಅಪ್ಲೋಡ್ ಮಾಡಿ (ಪ್ರತಿ ಫೈಲ್ ಒಂದು ಕಾಲಮ್):",
    predictAllBtn: "ಎಲ್ಲರಿಗೂ ಅಪಾಯ ಭವಿಷ್ಯವಾಣಿ ಮಾಡಿ",
    selectSchoolId: "ದಯವಿಟ್ಟು ಶಾಲೆ ಐಡಿ ನಮೂದಿಸಿ!",
    selectFile: "ದಯವಿಟ್ಟು ಫೈಲ್ ಆಯ್ಕೆಮಾಡಿ!",
    selectFiles: "ದಯವಿಟ್ಟು ಫೈಲ್‌ಗಳನ್ನು ಆಯ್ಕೆಮಾಡಿ!",
    predicting: "ಭವಿಷ್ಯವಾಣಿ ಮಾಡಲಾಗುತ್ತಿದೆ...",
    predictionDone: "ಭವಿಷ್ಯವಾಣಿ ಪೂರ್ಣಗೊಂಡಿದೆ!",
    apiError: "API ವಿನಂತಿ ವಿಫಲವಾಗಿದೆ",
    error: "ದೋಷ",
    atRisk: "ಅಪಾಯದಲ್ಲಿದೆ",
    notAtRisk: "ಅಪಾಯದಲ್ಲಿಲ್ಲ",
    student: "ವಿದ್ಯಾರ್ಥಿ",
    class: "ವರ್ಗ",
    attendance: "ಹಾಜರಿ",
    fees: "ಶುಲ್ಕ",
    marks: "ಅಂಕಗಳು",
    dropoutRisk: "ಡ್ರಾಪ್‌ಔಟ್ ಅಪಾಯ",
    probability: "ಪ್ರಾಬಬಿಲಿಟಿ (%)"
  },
  mr: {
    title: "उदय शिक्षक डॅशबोर्ड",
    header: "उदय शिक्षक डॅशबोर्ड",
    studentRisk: "विद्यार्थी ड्रॉपआउट धोका भाकीत",
    schoolIdLabel: "शाळेची आयडी प्रविष्ट करा (अ‍ॅडमिन प्रमाणे):",
    inputMethodLabel: "इनपुट पद्धत निवडा:",
    inputManual: "स्वहस्ते विद्यार्थी डेटा टाका",
    inputSingle: "एकच एक्सेल फाइल अपलोड करा",
    inputMultiple: "एकाधिक एक्सेल फाईल्स अपलोड करा (प्रत्येक फाईल एक कॉलम)",
    studentNamePh: "विद्यार्थी नाव",
    studentClassPh: "वर्ग",
    attendancePh: "उपस्थिती (%)",
    feesPh: "फी भरली",
    marksPh: "गुण (%)",
    predictBtn: "धोका भाकीत करा",
    singleExcelLabel: "एक्सेल फाइल अपलोड करा (नाव, वर्ग, उपस्थिती, फी, गुण):",
    multipleExcelLabel: "एकाधिक एक्सेल फाईल्स अपलोड करा (प्रत्येक फाईल एक कॉलम):",
    predictAllBtn: "सर्वांसाठी धोका भाकीत करा",
    selectSchoolId: "कृपया शाळेची आयडी टाका!",
    selectFile: "कृपया फाइल निवडा!",
    selectFiles: "कृपया फाईल्स निवडा!",
    predicting: "भाकीत चालू आहे...",
    predictionDone: "भाकीत पूर्ण!",
    apiError: "API विनंती अयशस्वी",
    error: "त्रुटी",
    atRisk: "धोक्यात",
    notAtRisk: "धोक्यात नाही",
    student: "विद्यार्थी",
    class: "वर्ग",
    attendance: "उपस्थिती",
    fees: "फी",
    marks: "गुण",
    dropoutRisk: "ड्रॉपआउट धोका",
    probability: "शक्यता (%)"
  }
};

// --- Language Switcher ---
function updateLanguage() {
  const lang = document.getElementById("languageSelect").value;
  const t = translations[lang];
  // Title
  document.title = t.title;
  // All [data-lang]
  document.querySelectorAll("[data-lang]").forEach(el => {
    if(el.dataset.lang && t[el.dataset.lang]) el.innerText = t[el.dataset.lang];
  });
  // All [data-lang-placeholder]
  document.querySelectorAll("[data-lang-placeholder]").forEach(el => {
    if(el.dataset.langPlaceholder && t[el.dataset.langPlaceholder]) el.placeholder = t[el.dataset.langPlaceholder];
  });
  // Update option text in select (inputMethod)
  document.querySelectorAll("#inputMethod option").forEach(opt=>{
    if(opt.dataset.lang && t[opt.dataset.lang]) opt.innerText = t[opt.dataset.lang];
  });
}
document.getElementById("languageSelect").addEventListener("change", updateLanguage);
window.addEventListener("DOMContentLoaded", updateLanguage);

// --- Toast Helper ---
function showToast(msg, type="success") {
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.className = "toast show " + (type==="error" ? "bg-red-600" : "bg-purple-600");
  toast.innerText = msg;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// --- Input Method Toggle ---
document.getElementById("inputMethod").addEventListener("change", (e) => {
  document.getElementById("manualForm").classList.toggle("hidden", e.target.value !== "manual");
  document.getElementById("singleExcelDiv").classList.toggle("hidden", e.target.value !== "single");
  document.getElementById("multipleExcelDiv").classList.toggle("hidden", e.target.value !== "multiple");
  document.getElementById("resultTable").classList.add("hidden");
});

// --- Manual Form Handler ---
document.getElementById("manualForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const lang = document.getElementById("languageSelect").value;
  const t = translations[lang];
  const school_id = document.getElementById("schoolIdInput").value.trim();
  if(!school_id){ showToast(t.selectSchoolId, "error"); return; }
  const student = {
    Name: document.getElementById("studentName").value,
    Class: document.getElementById("studentClass").value,
    Attendance: parseFloat(document.getElementById("attendance").value),
    Fees: parseFloat(document.getElementById("fees").value),
    Marks: parseFloat(document.getElementById("marks").value)
  };
  await predictAndDisplay([student], school_id, t);
});

// --- Single Excel File Handler ---
window.predictSingleExcel = async function() {
  const lang = document.getElementById("languageSelect").value;
  const t = translations[lang];
  const school_id = document.getElementById("schoolIdInput").value.trim();
  if(!school_id){ showToast(t.selectSchoolId, "error"); return; }
  const fileInput = document.getElementById("singleExcelFile");
  if(!fileInput.files[0]){ showToast(t.selectFile, "error"); return; }
  const reader = new FileReader();
  reader.onload = async function(e){
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type: "array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const students = XLSX.utils.sheet_to_json(sheet);
    await predictAndDisplay(students, school_id, t);
  };
  reader.readAsArrayBuffer(fileInput.files[0]);
}

// --- Multiple Excel Files Handler ---
window.predictMultipleExcel = async function() {
  const lang = document.getElementById("languageSelect").value;
  const t = translations[lang];
  const school_id = document.getElementById("schoolIdInput").value.trim();
  if(!school_id){ showToast(t.selectSchoolId, "error"); return; }
  const files = document.getElementById("multipleExcelFiles").files;
  if(!files.length){ showToast(t.selectFiles, "error"); return; }
  let columns = [];
  let colNames = [];
  for(let i=0; i<files.length; i++){
    const file = files[i];
    const reader = new FileReader();
    await new Promise(resolve => {
      reader.onload = function(e){
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type: "array"});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const col = XLSX.utils.sheet_to_json(sheet, {header:1});
        if(col.length > 1){
          const header = col[0][0];
          colNames.push(header);
          columns.push(col.slice(1).map(row => row[0]));
        }
        resolve();
      };
      reader.readAsArrayBuffer(file);
    });
  }
  const numRows = Math.max(...columns.map(col => col.length));
  const students = [];
  for(let i=0; i<numRows; i++){
    const student = {};
    for(let j=0; j<columns.length; j++){
      student[colNames[j]] = columns[j][i];
    }
    students.push(student);
  }
  await predictAndDisplay(students, school_id, t);
}

// --- Predict and Display Table ---
async function predictAndDisplay(students, school_id, t) {
  showToast(t.predicting);
  try {
    // Send request
    const response = await fetch(PREDICTION_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ school_id, student_data: students })
    });

    let result;
    try {
      result = await response.json();
    } catch (jsonErr) {
      console.error("Failed to parse JSON:", jsonErr);
      showToast("Invalid API response!", "error");
      renderResultTable(students, [], [], t); // still render table with placeholders
      return;
    }

    console.log("API response:", result);

    // Validate predictions
    const predictions = result.predictions || [];
    const probabilities = result.probabilities || [];

    if (predictions.length !== students.length) {
      console.warn("Predictions length mismatch:", predictions.length, students.length);
      showToast("Prediction returned incomplete data!", "error");
    }

    renderResultTable(students, predictions, probabilities, t);
    showToast(t.predictionDone);
  } catch (err) {
    console.error("API Error:", err);
    showToast((t.error || "Error") + ": " + (err.message || err), "error");
    renderResultTable(students, [], [], t); // show table with placeholders
  }
}

// --- Render Table (with translation support) ---
function renderResultTable(students, predictions, probabilities, t){
  const table = document.getElementById("resultTable");
  table.classList.remove("hidden");
  table.innerHTML = `<tr class="bg-purple-700">
    <th class="p-2">${t.student}</th>
    <th class="p-2">${t.class}</th>
    <th class="p-2">${t.attendance}</th>
    <th class="p-2">${t.fees}</th>
    <th class="p-2">${t.marks}</th>
    <th class="p-2">${t.dropoutRisk}</th>
    <th class="p-2">${t.probability}</th>
  </tr>` + students.map((s,i)=>`
    <tr class="bg-gray-700">
      <td class="p-2">${s.Name||'-'}</td>
      <td class="p-2">${s.Class||'-'}</td>
      <td class="p-2">${s.Attendance||'-'}</td>
      <td class="p-2">${s.Fees||'-'}</td>
      <td class="p-2">${s.Marks||'-'}</td>
      <td class="p-2">${predictions[i]==1?t.atRisk:t.notAtRisk}</td>
      <td class="p-2">${probabilities[i]?.toFixed(2)||'-'}</td>
    </tr>
  `).join('');
}
</script>
</body>
</html>